#!/usr/bin/env php
<?php

require __DIR__ . "/../../../autoload.php";

use Flagship\Decision\BucketingPolling;
use Flagship\Enum\FlagshipConstant;
use Flagship\Utils\HttpClient;

function startPolling($envId, $pollingInterval, $bucketingDirectory = null, $configFile = null)
{
    $bucketingPolling = new BucketingPolling($envId, $pollingInterval, new HttpClient(), $bucketingDirectory, $configFile);
    $bucketingPolling->startPolling();
}
$isRunning =  getenv('FLAGSHIP-DOCKER');

if ($isRunning){
    $envId = getenv('FLAGSHIP_ENV_ID');
    if (!$envId){
        fwrite(
            STDERR,
            "FLAGSHIP_ENV_ID field is missing" . PHP_EOL
        );
        die(1);
    }

    $pollingInterval = getenv('FLAGSHIP_POLLING_INTERVAL');

    if (!$pollingInterval){
        $pollingInterval = FlagshipConstant::REQUEST_TIME_OUT * 1000;
        fwrite(
            STDERR,
            "FLAGSHIP_POLLING_INTERVAL field is missing default value will be used 2000ms" . PHP_EOL
        );
    }

    $bucketingDirectory = getenv('FLAGSHIP_BUCKETING_DIRECTORY');

    if (!$bucketingDirectory){
        fwrite(
            STDERR,
            "FLAGSHIP_BUCKETING_DIRECTORY field is missing default value will be used" . PHP_EOL
        );
    }

    $configFile = getenv('FLAGSHIP_CONFIG_FILE');

    if (!$configFile){
        fwrite(
            STDERR,
            "FLAGSHIP_CONFIG_FILE field is missing" . PHP_EOL
        );
    }

    startPolling($envId, $pollingInterval, $bucketingDirectory, $configFile);

    die(0);
}

$fileConfig = null;

// argument --file=flagship.json
if (isset($argv[1])) {
   $fileArgument = getopt(null, ["file:"]);

   if (isset($fileArgument['file'])){
       $fileConfig =$fileArgument['file'];
   }
}

if (!$fileConfig){
    $fileConfig = 'flagship.json';
}

if (!file_exists($fileConfig)){
    fwrite(
        STDERR,
        "flagship config file not found" . PHP_EOL
    );
    die(1);
}

$fileContent = file_get_contents($fileConfig);

$configArray = json_decode($fileContent, true);

if (!$configArray){
    fwrite(
        STDERR,
        "flagship config malformed" . PHP_EOL
    );
    die(1);
}

if (!isset($configArray['envId'])){
    fwrite(
        STDERR,
        "envId field is missing" . PHP_EOL
    );
    die(1);
}

$pollingInterval = null;

if (!isset($configArray['pollingInterval'])){

    $pollingInterval = FlagshipConstant::REQUEST_TIME_OUT * 1000;

    fwrite(
        STDERR,
        "pollingInterval field is missing, default value will be used 2000ms" . PHP_EOL
    );
}

if (!is_numeric($configArray['pollingInterval'])){
    $pollingInterval = FlagshipConstant::REQUEST_TIME_OUT * 1000;
    fwrite(
        STDERR,
        "pollingInterval is not numeric, default value will be used 2000ms" . PHP_EOL
    );
}


if (!isset($configArray['bucketingDirectory'])){
    $configArray['bucketingDirectory']=null;
    fwrite(
        STDERR,
        "bucketingDirectory field is missing default value will be used" . PHP_EOL
    );
}

$envId = $configArray['envId'];
$bucketingDirectory = $configArray['bucketingDirectory'];

if (!$pollingInterval){
    $pollingInterval = $configArray['pollingInterval'];
}

startPolling($envId, $pollingInterval, $bucketingDirectory, $fileConfig);