#!/usr/bin/env php
<?php

require __DIR__ . "/../vendor/autoload.php";

use Flagship\Enum\FlagshipConstant;
use Flagship\Utils\HttpClient;

// argument environment Id
if (!isset($argv[1])) {
    echo 'argument environment Id null';
    exit(1);
}

$envId = $argv[1];
$pollingInterval = FlagshipConstant::REQUEST_TIME_OUT;
// argument pollingInterval
if (isset($argv[2])) {
    $pollingInterval = $argv[2];
}

while (true) {
    try {
        echo 'start';
        $httpClient = new HttpClient();
        $url = "https://cdn.flagship.io/$envId/bucketing.json";
        $response = $httpClient->get($url);
        $bucketingFile = __DIR__ . "/../bucketing.json";
        file_put_contents($bucketingFile, json_encode($response->getBody()));

        echo 'sleep';
        sleep($pollingInterval);
        echo 'end sleep';
    } catch (Exception $exception) {
        var_dump($exception);
    }
}
